<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
  <th:block th:replace="~{fragments/_head :: head('Pago — Botica Online')}"></th:block>
<body class="bg-light">
  <th:block th:replace="~{fragments/_navbar :: navbar}"></th:block>

  <!-- ===== Estilos específicos de la página ===== -->
  <style>
    :root{
      --prim: var(--autumn-pine-green, #1C3D3A);
      --sec:  var(--dark-green, #2C4F47);
      --mint: var(--pristine-oceanic, #4FB0A6);
      --paper:var(--white-doctor, #F1F9F9);
    }
    .page-hero{
      background: linear-gradient(135deg, var(--mint) 0%, var(--paper) 55%);
      border-radius: 16px;
    }
    .checkout-steps{ list-style:none; display:flex; gap:.5rem; padding:0; margin:0 }
    .checkout-steps li{
      display:flex; align-items:center; gap:.5rem; padding:.5rem .75rem;
      border-radius:999px; background:#e7f5f2; color:var(--sec); font-weight:600;
    }
    .checkout-steps li.active{ background:var(--prim); color:#fff }
    .checkout-steps li.done{ background:#cfe8e3 }

    .method{ border:1.5px solid #e9f0ef; border-radius:14px; cursor:pointer; transition:.15s ease }
    .method input{ display:none }
    .method .check{ width:22px; height:22px; border:2px solid #b6c9c6; border-radius:999px; display:inline-flex; align-items:center; justify-content:center; margin-right:.5rem }
    .method input:checked + label .check{ border-color:var(--prim); background:var(--prim); color:#fff }
    .method:hover{ transform:translateY(-2px); box-shadow:0 12px 26px rgba(0,0,0,.08) }

    .summary-card{ position:sticky; top:1rem; border-radius:16px }
    .summary-total{ background:var(--prim); color:#fff; border-radius:12px }
    .secure-note i{ color:var(--prim) }
    .field-hint{ font-size:.8rem; color:#6c757d }

    .qr-box{ background:#f8faf9; border:1px dashed var(--mint); border-radius:14px }
    .divider-label{ display:flex; align-items:center; gap:.75rem; color:#6c757d; font-size:.9rem }
    .divider-label::before,.divider-label::after{ content:""; height:1px; background:#dee2e6; flex:1 }

    .timer{ display:inline-flex; align-items:center; gap:.35rem; padding:.35rem .6rem; border-radius:999px; background:#fff; border:1px solid #e5eeec; font-weight:600 }
    .timer i{ color:var(--prim) }

    @media (max-width: 991.98px){
      .summary-card{ position:static }
    }
  </style>

  <main class="container py-4">

    <!-- HERO + STEPPER + TIMER -->
    <div class="page-hero p-3 p-md-4 mb-4 small-shadow">
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
        <h2 class="fw-bold m-0">Pago</h2>
        <div class="timer"><i class="bi bi-stopwatch"></i> <span id="timer">15:00</span> sesión activa</div>
      </div>
      <ol class="checkout-steps mt-2">
        <li class="done"><i class="bi bi-bag-check"></i> Carrito</li>
        <li class="active"><i class="bi bi-credit-card"></i> Pago</li>
        <li><i class="bi bi-receipt"></i> Comprobante</li>
      </ol>
    </div>

    <div class="row g-4">

      <!-- ===== Columna izquierda ===== -->
      <div class="col-lg-8">

        <!-- Métodos -->
        <section class="bg-white rounded-4 small-shadow p-3 p-md-4">
          <h5 class="fw-bold mb-3">Selecciona tu método de pago</h5>

          <div class="row g-3">
            <!-- Yape -->
            <div class="col-md-6">
              <div class="method p-3 h-100">
                <input type="radio" name="metodo" id="m_yape" checked>
                <label class="d-flex align-items-start m-0" for="m_yape">
                  <span class="check"><i class="bi bi-check-lg small"></i></span>
                  <div>
                    <div class="fw-semibold">Yape</div>
                    <div class="text-muted small">Paga con QR desde tu celular.</div>
                  </div>
                  <i class="bi bi-qr-code ms-auto fs-4 text-muted"></i>
                </label>
              </div>
            </div>

            <!-- Plin -->
            <div class="col-md-6">
              <div class="method p-3 h-100">
                <input type="radio" name="metodo" id="m_plin">
                <label class="d-flex align-items-start m-0" for="m_plin">
                  <span class="check"><i class="bi bi-check-lg small"></i></span>
                  <div>
                    <div class="fw-semibold">Plin</div>
                    <div class="text-muted small">Transfiere seguro vía Plin.</div>
                  </div>
                  <i class="bi bi-phone ms-auto fs-4 text-muted"></i>
                </label>
              </div>
            </div>

            <!-- Tarjeta -->
            <div class="col-md-6">
              <div class="method p-3 h-100">
                <input type="radio" name="metodo" id="m_card">
                <label class="d-flex align-items-start m-0" for="m_card">
                  <span class="check"><i class="bi bi-check-lg small"></i></span>
                  <div>
                    <div class="fw-semibold">Tarjeta</div>
                    <div class="text-muted small">Crédito o débito.</div>
                  </div>
                  <i class="bi bi-credit-card-2-front ms-auto fs-4 text-muted"></i>
                </label>
              </div>
            </div>

            <!-- Efectivo -->
            <div class="col-md-6">
              <div class="method p-3 h-100">
                <input type="radio" name="metodo" id="m_cash">
                <label class="d-flex align-items-start m-0" for="m_cash">
                  <span class="check"><i class="bi bi-check-lg small"></i></span>
                  <div>
                    <div class="fw-semibold">Efectivo</div>
                    <div class="text-muted small">Pago contra entrega.</div>
                  </div>
                  <i class="bi bi-cash-coin ms-auto fs-4 text-muted"></i>
                </label>
              </div>
            </div>
          </div>
        </section>

        <!-- Contenido dinámico por método -->
        <section class="mt-3">

          <!-- QR Yape/Plin -->
          <div id="box-qr" class="bg-white rounded-4 small-shadow p-3 p-md-4 qr-box">
            <h6 class="fw-bold mb-2"><i class="bi bi-qr-code"></i> Escanea el código</h6>
            <div class="row g-3 align-items-center">
              <div class="col-sm-5">
                <div class="ratio ratio-1x1 rounded-3 overflow-hidden bg-white p-3">
                  <img th:src="@{/img/qr-demo.jpg}" alt="QR de pago" class="w-100 h-100 object-fit-contain">
                </div>
              </div>
              <div class="col-sm-7">
                <ul class="small text-muted mb-2">
                  <li>Abre <strong>Yape</strong> o <strong>Plin</strong> y escanea el QR.</li>
                  <li>Verifica el monto y confirma el pago.</li>
                  <li>Automáticamente validaremos tu pago.</li>
                </ul>
                <form th:action="@{/checkout/confirmar}" method="post" class="d-flex gap-2">
                  <input class="form-control" name="ref" placeholder="Ingresa el código de operación (opcional)">
                  <button class="btn btn-primary">Ya pagué</button>
                </form>
              </div>
            </div>
          </div>

          <!-- Tarjeta -->
          <div id="box-card" class="bg-white rounded-4 small-shadow p-3 p-md-4 mt-3 d-none">
            <h6 class="fw-bold mb-3"><i class="bi bi-credit-card"></i> Detalles de la tarjeta</h6>
            <form th:action="@{/checkout/confirmar}" method="post" class="vstack gap-3">
              <div>
                <label class="form-label">Titular</label>
                <input class="form-control" name="card_name" placeholder="Como aparece en la tarjeta" required>
              </div>
              <div>
                <label class="form-label">Número</label>
                <input class="form-control" name="card_number" inputmode="numeric" maxlength="19" placeholder="XXXX XXXX XXXX XXXX" required>
                <div class="field-hint">Aceptamos Visa, MasterCard y Amex.</div>
              </div>
              <div class="row g-3">
                <div class="col-sm-4">
                  <label class="form-label">Mes</label>
                  <input class="form-control" name="card_mm" placeholder="MM" inputmode="numeric" maxlength="2" required>
                </div>
                <div class="col-sm-4">
                  <label class="form-label">Año</label>
                  <input class="form-control" name="card_yy" placeholder="AA" inputmode="numeric" maxlength="2" required>
                </div>
                <div class="col-sm-4">
                  <label class="form-label">CVV</label>
                  <div class="input-group">
                    <input class="form-control" name="card_cvv" placeholder="CVV" inputmode="numeric" maxlength="4" required>
                    <span class="input-group-text" title="3 o 4 dígitos al reverso"><i class="bi bi-info-circle"></i></span>
                  </div>
                </div>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="saveCard">
                <label class="form-check-label" for="saveCard">Guardar tarjeta para futuras compras</label>
              </div>
              <button class="btn btn-primary btn-lg">Pagar con tarjeta</button>
            </form>
          </div>

          <!-- Efectivo -->
          <div id="box-cash" class="bg-white rounded-4 small-shadow p-3 p-md-4 mt-3 d-none">
            <h6 class="fw-bold mb-2"><i class="bi bi-cash"></i> Pagar en efectivo</h6>
            <p class="text-muted small mb-3">Pagarás al repartidor al recibir tu pedido.</p>
            <form th:action="@{/checkout/confirmar}" method="post" class="vstack gap-3">
              <div>
                <label class="form-label">Monto aproximado con el que pagarás</label>
                <input class="form-control" name="cash_amount" placeholder="Ej: 100.00">
                <div class="field-hint">Nos ayuda a llevar cambio suficiente.</div>
              </div>
              <button class="btn btn-primary btn-lg">Confirmar pedido</button>
            </form>
          </div>

        </section>

        <!-- Dirección + Cupón + Términos -->
        <section class="row g-3 mt-3">
          <div class="col-md-8">
            <div class="bg-white rounded-4 small-shadow p-3 p-md-4 h-100">
              <h6 class="fw-bold mb-2"><i class="bi bi-geo-alt"></i> Dirección de entrega</h6>
              <form th:action="@{/checkout/direccion}" method="post" class="vstack gap-2">
                <input class="form-control" name="direccion"
                       th:value="${direccion}" placeholder="Calle, número, distrito" required>
                <div class="row g-2">
                  <div class="col-md-6">
                    <input class="form-control" name="referencia" placeholder="Referencia (opcional)">
                  </div>
                  <div class="col-md-6">
                    <input class="form-control" name="telefono" placeholder="Teléfono de contacto" required>
                  </div>
                </div>
              </form>
            </div>
          </div>
          <div class="col-md-4">
            <div class="bg-white rounded-4 small-shadow p-3 p-md-4 h-100">
              <h6 class="fw-bold mb-2"><i class="bi bi-ticket-perforated"></i> Cupón</h6>
              <form th:action="@{/carrito/cupon}" method="post" class="d-flex gap-2">
                <input class="form-control" name="codigo" placeholder="SALUD10">
                <button class="btn btn-outline-secondary">Aplicar</button>
              </form>
            </div>
          </div>
          <div class="col-12">
            <div class="bg-white rounded-4 small-shadow p-3 p-md-4">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="terms" checked required>
                <label class="form-check-label" for="terms">
                  Acepto los <a href="#" class="text-decoration-none">términos y condiciones</a> y la <a href="#" class="text-decoration-none">política de privacidad</a>.
                </label>
              </div>
              <div class="secure-note small text-muted mt-2">
                <i class="bi bi-shield-lock"></i> Tus datos se procesan de forma segura. Cumplimos con PCI-DSS.
              </div>
            </div>
          </div>
        </section>

        <!-- Badges -->
        <div class="row row-cols-2 row-cols-md-4 g-3 mt-1">
          <div class="col"><div class="p-3 bg-white rounded-4 small-shadow d-flex align-items-center gap-2"><i class="bi bi-shield-check fs-4"></i><span class="small">Pago seguro</span></div></div>
          <div class="col"><div class="p-3 bg-white rounded-4 small-shadow d-flex align-items-center gap-2"><i class="bi bi-truck fs-4"></i><span class="small">Entrega rápida</span></div></div>
          <div class="col"><div class="p-3 bg-white rounded-4 small-shadow d-flex align-items-center gap-2"><i class="bi bi-arrow-repeat fs-4"></i><span class="small">Devolución 7 días</span></div></div>
          <div class="col"><div class="p-3 bg-white rounded-4 small-shadow d-flex align-items-center gap-2"><i class="bi bi-headset fs-4"></i><span class="small">Soporte 24/7</span></div></div>
        </div>

      </div>

      <!-- ===== Columna derecha (resumen) ===== -->
      <div class="col-lg-4">
        <aside class="bg-white rounded-4 small-shadow p-3 p-md-4 summary-card">
          <h5 class="fw-bold">Resumen</h5>

          <div class="d-flex justify-content-between small mt-2">
            <span>Subtotal</span>
            <span>S/. <span th:text="${#numbers.formatDecimal(subtotal,1,2)}">0.00</span></span>
          </div>
          <div class="d-flex justify-content-between small">
            <span>Descuento</span>
            <span>- S/. <span th:text="${#numbers.formatDecimal(descuento,1,2)}">0.00</span></span>
          </div>
          <div class="d-flex justify-content-between small">
            <span>Envío</span>
            <span th:text="${envio>0 ? 'S/. ' + #numbers.formatDecimal(envio,1,2) : 'Gratis'}">Gratis</span>
          </div>
          <div class="d-flex justify-content-between small">
            <span>IGV (18%)</span>
            <span>S/. <span th:text="${#numbers.formatDecimal(igv,1,2)}">0.00</span></span>
          </div>

          <div class="summary-total d-flex justify-content-between align-items-center p-3 mt-2 fw-bold">
            <span>Total</span>
            <span>S/. <span th:text="${#numbers.formatDecimal(total,1,2)}">0.00</span></span>
          </div>

          <button id="btnPagar" class="btn btn-primary w-100 mt-3">
            <i class="bi bi-lock"></i> Finalizar pago
          </button>
          <a class="btn btn-outline-secondary w-100 mt-2" th:href="@{/carrito}">← Volver al carrito</a>

          <div class="small text-muted mt-3"><i class="bi bi-info-circle"></i> Verás el detalle del pago en el comprobante.</div>
        </aside>
      </div>

    </div>
  </main>

  <!-- ===== JS: timer + conmutación de métodos ===== -->
  <script>
    // Timer 15:00 regresivo
    (function(){
      let secs = 15*60, t = document.getElementById('timer');
      const tick = () => {
        const m = String(Math.floor(secs/60)).padStart(2,'0');
        const s = String(secs%60).padStart(2,'0');
        t.textContent = m+':'+s;
        if(secs>0) { secs--; setTimeout(tick, 1000); }
      }; tick();
    })();

    // Mostrar/ocultar cajas según método
    const yape = document.getElementById('m_yape');
    const plin = document.getElementById('m_plin');
    const card = document.getElementById('m_card');
    const cash = document.getElementById('m_cash');
    const boxQR = document.getElementById('box-qr');
    const boxCard = document.getElementById('box-card');
    const boxCash = document.getElementById('box-cash');
    const btnPagar = document.getElementById('btnPagar');

    function refreshBoxes(){
      const isQR = yape.checked || plin.checked;
      boxQR.classList.toggle('d-none', !isQR);
      boxCard.classList.toggle('d-none', !card.checked);
      boxCash.classList.toggle('d-none', !cash.checked);

      // CTA coherente
      btnPagar.textContent = card.checked ? 'Pagar con tarjeta' :
                             cash.checked ? 'Confirmar pedido' : 'Finalizar pago';
    }
    document.addEventListener('change', (e)=>{
      if([yape,plin,card,cash].includes(e.target)) refreshBoxes();
    });
    refreshBoxes();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
