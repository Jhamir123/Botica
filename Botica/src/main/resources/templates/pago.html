<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{fragments/_head :: head('Pago — Botica Online')}"></th:block>

<body class="bg-light">
  <th:block th:replace="~{fragments/_navbar :: navbar(active='pago')}"></th:block>

  <main class="container py-4" th:with="
          sub=${subtotal!=null?subtotal.doubleValue():0.0},
          dsc=${descuento!=null?descuento.doubleValue():0.0},
          tax=${igv!=null?igv.doubleValue():0.0},
          ttl=${total!=null?total.doubleValue():(sub-dsc+tax)}
        ">

    <div class="bg-white rounded-4 p-3 p-md-4 small-shadow mb-4">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <h2 class="fw-bold m-0 text-dark">Finalizar pago</h2>
        <ol class="checkout-steps" style="list-style:none;display:flex;gap:.5rem;">
          <li class="done" style="background:#cfe8e3;padding:.4rem .7rem;border-radius:999px;">Carrito</li>
          <li class="active" style="background:#1C3D3A;color:#fff;padding:.4rem .7rem;border-radius:999px;">Pago</li>
          <li style="background:#e7f5f2;padding:.4rem .7rem;border-radius:999px;">Comprobante</li>
        </ol>
      </div>
    </div>

    <div class="row g-4">
      <div class="col-lg-8">
        <section class="bg-white rounded-4 p-3 p-md-4 small-shadow mb-3">
          <h5 class="fw-bold mb-3">Datos del comprador</h5>
          <form th:action="@{/pago/confirmar}" method="post" id="form-pago" class="vstack gap-3">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Nombres</label>
                <input class="form-control" name="nombres" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Apellidos</label>
                <input class="form-control" name="apellidos" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Celular</label>
                <input class="form-control" name="celular" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Correo</label>
                <input class="form-control" name="correo" type="email" required>
              </div>
            </div>

            <hr class="my-2">

            <h6 class="fw-bold mb-2">Método de pago</h6>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="metodoPago" id="mp-yape" value="YAPE" checked>
              <label class="form-check-label" for="mp-yape">Yape / Plin (QR)</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="metodoPago" id="mp-tarjeta" value="TARJETA">
              <label class="form-check-label" for="mp-tarjeta">Tarjeta</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="metodoPago" id="mp-efectivo" value="EFECTIVO">
              <label class="form-check-label" for="mp-efectivo">Efectivo</label>
            </div>

            <!-- QR Yape -->
            <div id="qrYape" class="text-center mt-3">
              <img src="/img/qr-demo.jpg" alt="QR Yape" class="rounded-4 small-shadow" style="max-width:220px;">
              <div class="small text-muted mt-2">Escanea el código QR para completar el pago.</div>
            </div>

            <!-- Datos de tarjeta -->
            <div id="tarjetaFields" class="mt-3" style="display:none;">
              <div class="row g-3">
                <div class="col-12">
                  <label class="form-label">Número de tarjeta</label>
                  <input class="form-control" name="cardNumber">
                </div>
                <div class="col-6">
                  <label class="form-label">Vencimiento</label>
                  <input class="form-control" name="cardExp" placeholder="MM/AA">
                </div>
                <div class="col-6">
                  <label class="form-label">CVV</label>
                  <input class="form-control" name="cardCvv">
                </div>
              </div>
            </div>

            <div class="form-check mt-3">
              <input class="form-check-input" type="checkbox" required>
              <label class="form-check-label">Acepto los términos y condiciones.</label>
            </div>

            <button class="btn btn-primary mt-3" type="submit"><i class="bi bi-credit-card"></i> Pagar ahora</button>
          </form>
        </section>
      </div>

      <!-- Resumen -->
      <div class="col-lg-4">
        <div class="bg-white rounded-4 p-3 p-md-4 small-shadow position-sticky" style="top:1.25rem;">
          <h5 class="fw-bold mb-3">Resumen</h5>
          <div class="d-flex justify-content-between small mb-2">
            <span>Subtotal</span>
            <span>S/. <span th:text="${#numbers.formatDecimal(sub,1,2)}">0.00</span></span>
          </div>
          <div class="d-flex justify-content-between small mb-2">
            <span>Descuento</span>
            <span>- S/. <span th:text="${#numbers.formatDecimal(dsc,1,2)}">0.00</span></span>
          </div>
          <div class="d-flex justify-content-between small mb-2">
            <span>IGV (18%)</span>
            <span>S/. <span th:text="${#numbers.formatDecimal(tax,1,2)}">0.00</span></span>
          </div>
          <div class="d-flex justify-content-between align-items-center fw-bold p-3 rounded"
            style="background:#1C3D3A;color:#fff;">
            <span>Total</span>
            <span>S/. <span th:text="${#numbers.formatDecimal(ttl,1,2)}">0.00</span></span>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    (function () {
      const radios = document.querySelectorAll('input[name="metodoPago"]');
      const tarjeta = document.getElementById('tarjetaFields');
      const qr = document.getElementById('qrYape');
      const toggle = () => {
        const val = document.querySelector('input[name="metodoPago"]:checked')?.value;
        tarjeta.style.display = (val === 'TARJETA') ? 'block' : 'none';
        qr.style.display = (val === 'YAPE') ? 'block' : 'none';
      };
      radios.forEach(r => r.addEventListener('change', toggle));
      toggle();
    })();
  </script>
</body>

</html>