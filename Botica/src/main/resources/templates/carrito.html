<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
  <th:block th:replace="~{fragments/_head :: head('Carrito — Botica Online')}"></th:block>
<body class="bg-light">
  <!-- NAVBAR -->
  <th:block th:replace="~{fragments/_navbar :: navbar(active='carrito')}"></th:block>

  <style>
    :root{
      --prim:#1C3D3A; --sec:#2C4F47; --mint:#4FB0A6; --paper:#F1F9F9;
    }
    .cart-hero{ background: linear-gradient(135deg,var(--mint)0%,var(--paper)55%); border-radius:16px; }
    .checkout-steps{ list-style:none; display:flex; gap:.5rem; padding:0; margin:0 }
    .checkout-steps li{ display:flex; align-items:center; gap:.5rem; padding:.5rem .75rem; border-radius:999px; background:#e7f5f2; color:var(--sec); font-weight:600; }
    .checkout-steps li.active{ background:var(--prim); color:#fff }
    .checkout-steps li.done{ background:#cfe8e3 }
    .cart-item{ border:1px solid #eef2f2; border-radius:16px }
    .qty-btn{ width:38px }
    .summary-card{ position:sticky; top:1.25rem; border-radius:16px }
    .summary-total{ background:var(--prim); color:#fff; border-radius:12px; }
    .trust-badges i{ color:var(--prim) }
    .reco-card{ border-radius:14px; transition:transform .15s ease, box-shadow .15s ease }
    .reco-card:hover{ transform: translateY(-2px); box-shadow:0 12px 28px rgba(0,0,0,.08) }
  </style>

  <main class="container py-4">

    <div class="cart-hero p-3 p-md-4 mb-4 small-shadow">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <h2 class="fw-bold m-0 text-dark">Tu Carrito</h2>
        <ol class="checkout-steps">
          <li class="active"><i class="bi bi-bag"></i> Carrito</li>
          <li><i class="bi bi-credit-card"></i> Pago</li>
          <li><i class="bi bi-receipt"></i> Comprobante</li>
        </ol>
      </div>
    </div>

    <div class="row g-4">

      <div class="col-lg-8">
        <!-- Lista de items -->
        <div class="vstack gap-3">
          <div class="p-3 bg-white cart-item small-shadow d-flex align-items-center"
               th:each="ci : ${carrito}">
            <div class="ratio ratio-1x1 rounded overflow-hidden me-3" style="width:80px">
              <img class="w-100 h-100 object-fit-cover" th:src="${ci.producto.imagenUrl}" th:alt="${ci.producto.nombre}">
            </div>

            <div class="flex-grow-1">
              <div class="d-flex justify-content-between align-items-start flex-wrap">
                <div>
                  <div class="fw-semibold" th:text="${ci.producto.nombre}">Producto</div>
                  <div class="text-muted small" th:text="${ci.producto.categoria}">Categoría</div>
                </div>
                <div class="text-end small text-muted">
                  P. Unit.: S/. <span th:text="${#numbers.formatDecimal(ci.producto.precio,1,2)}">0.00</span>
                </div>
              </div>

              <div class="d-flex align-items-center mt-2 gap-2">
                <form class="d-flex align-items-center" th:action="@{|/carrito/cambiar/${ci.producto.id}|}" method="post">
                  <button class="btn btn-outline-secondary qty-btn js-minus" type="button">−</button>
                  <input class="form-control text-center" style="width:80px" type="number" min="1" name="cantidad"
                         th:value="${ci.cantidad}">
                  <button class="btn btn-outline-secondary qty-btn js-plus" type="button">+</button>
                </form>

                <div class="ms-auto fw-semibold">
                  S/. <span th:text="${#numbers.formatDecimal(ci.importe,1,2)}">0.00</span>
                </div>

                <form th:action="@{|/carrito/eliminar/${ci.producto.id}|}" method="post">
                  <button class="btn btn-link text-danger" title="Eliminar">
                    <i class="bi bi-trash"></i>
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>

        <!-- Cupón -->
        <div class="p-3 bg-white rounded-4 small-shadow mt-4">
          <h6 class="fw-bold mb-2"><i class="bi bi-ticket-perforated"></i> Cupón de descuento</h6>
          <form th:action="@{/carrito/cupon}" method="post" class="d-flex gap-2">
            <input class="form-control" name="codigo" placeholder="EJ: SALUD10" />
            <button class="btn btn-primary">Aplicar</button>
          </form>
        </div>

        <!-- Recomendaciones -->
        <section class="mt-4">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="fw-bold m-0">También te puede interesar</h5>
            <a class="small text-decoration-none" th:href="@{/catalogo}">Ver todo <i class="bi bi-arrow-right"></i></a>
          </div>
          <div class="row g-3">
            <div class="col-6 col-md-4 col-lg-3" th:each="p : ${recomendados}">
              <article class="card reco-card h-100">
                <div class="ratio ratio-4x3">
                  <img class="card-img-top object-fit-cover" th:src="${p.imagenUrl}" th:alt="${p.nombre}">
                </div>
                <div class="card-body d-flex flex-column">
                  <div class="small text-muted" th:text="${p.categoria}">Categoría</div>
                  <strong class="mb-1" th:text="${p.nombre}">Producto</strong>
                  <div class="mt-auto">
                    <span class="fw-semibold">S/. <span th:text="${#numbers.formatDecimal(p.precio,1,2)}">0.00</span></span>
                    <form th:action="@{|/carrito/agregar/${p.id}|}" method="post" class="d-grid mt-2">
                      <input type="hidden" name="cantidad" value="1"/>
                      <button class="btn btn-outline-secondary btn-sm"><i class="bi bi-bag-plus"></i> Agregar</button>
                    </form>
                  </div>
                </div>
              </article>
            </div>
          </div>
        </section>
      </div>

      <div class="col-lg-4">
        <div class="p-3 bg-white small-shadow summary-card">
          <h5 class="fw-bold mb-3">Resumen del Pedido</h5>
          <div class="d-flex justify-content-between small mb-2">
            <span>Subtotal</span>
            <span>S/. <span th:text="${#numbers.formatDecimal(subtotal!=null?subtotal:0,1,2)}">0.00</span></span>
          </div>
          <div class="d-flex justify-content-between small mb-2">
            <span>Descuento</span>
            <span>- S/. <span th:text="${#numbers.formatDecimal(descuento!=null?descuento:0,1,2)}">0.00</span></span>
          </div>
          <div class="d-flex justify-content-between small mb-3">
            <span>IGV (18%)</span>
            <span>S/. <span th:text="${#numbers.formatDecimal(igv!=null?igv:0,1,2)}">0.00</span></span>
          </div>
          <div class="summary-total d-flex justify-content-between align-items-center p-3 fw-bold">
            <span>Total</span>
            <span>S/. <span th:text="${#numbers.formatDecimal(total!=null?total:0,1,2)}">0.00</span></span>
          </div>
          <a class="btn btn-primary w-100 mt-3" th:href="@{/pago}">
            <i class="bi bi-credit-card"></i> Confirmar pedido
          </a>
          <a class="btn btn-outline-secondary w-100 mt-2" th:href="@{/catalogo}">Seguir comprando</a>
        </div>
      </div>

    </div>
  </main>

  <script>
    document.addEventListener('click', e => {
      const minus = e.target.closest('.js-minus');
      const plus = e.target.closest('.js-plus');
      if (!minus && !plus) return;
      const form = (minus || plus).closest('form');
      const qty = form.querySelector('input[name="cantidad"]');
      if (minus) qty.stepDown();
      if (plus) qty.stepUp();
      form.submit();
    });
  </script>
</body>
</html>
